-- Validate, transform and merge into shadow tables. Replace LIB_STG_PLACEHOLDER with the target schema.
SET SCHEMA LIB_STG_PLACEHOLDER;

-- Reset staging tables
DELETE FROM RAC_STG_VALID;
DELETE FROM RAC_STG_REJECTS;

-- Simple parsing example: assume CSV format 'id,amount'
INSERT INTO RAC_STG_VALID (ID, AMOUNT)
SELECT CAST(SUBSTRING(RAW_LINE, 1, LOCATE(',', RAW_LINE) - 1) AS INT),
       CAST(SUBSTRING(RAW_LINE, LOCATE(',', RAW_LINE) + 1) AS DECIMAL(9,2))
FROM RAC_STG_IN
WHERE RAW_LINE LIKE '%,%'
  AND REGEXP_LIKE(SUBSTRING(RAW_LINE, 1, LOCATE(',', RAW_LINE) - 1), '^[0-9]+$')
  AND REGEXP_LIKE(SUBSTRING(RAW_LINE, LOCATE(',', RAW_LINE) + 1), '^-?[0-9]+(\\.[0-9]+)?$');

INSERT INTO RAC_STG_REJECTS (RAW_LINE, REASON)
SELECT RAW_LINE, 'PARSE_ERROR'
FROM RAC_STG_IN si
WHERE NOT EXISTS (
    SELECT 1 FROM RAC_STG_VALID sv WHERE sv.ID =
    CAST(SUBSTRING(si.RAW_LINE, 1, LOCATE(',', si.RAW_LINE) - 1) AS INT)
);

-- Update existing rows then insert new ones to avoid MERGE for compatibility
UPDATE RAC_SHADOW_PAYROLL T
SET AMOUNT = (SELECT S.AMOUNT FROM RAC_STG_VALID S WHERE S.ID = T.ID)
WHERE EXISTS (SELECT 1 FROM RAC_STG_VALID S WHERE S.ID = T.ID);

INSERT INTO RAC_SHADOW_PAYROLL (ID, AMOUNT)
SELECT S.ID, S.AMOUNT
FROM RAC_STG_VALID S
WHERE NOT EXISTS (SELECT 1 FROM RAC_SHADOW_PAYROLL T WHERE T.ID = S.ID);

INSERT INTO RAC_RUN_LOG (STATUS)
VALUES ('SUCCESS');
